using System;
using System.IO;
using System.Linq;
using NUnit.Framework;

namespace Microsoft.Maui.Controls.SourceGen.UnitTests;

public class DependencyFirst : SourceGenXamlInitializeComponentTestBase
{
	[Test]
	public void InflateusingTreeOrder()
	{
		var xaml =
"""
<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	x:Class="Test.TestPage"
	Title="Test Page">
		<StackLayout>
			<Button x:Name="MyButton" Text="Hello MAUI!" />
		</StackLayout>
</ContentPage>
""";

		var code =
"""
using System;
using Microsoft.Maui.Controls;
using Microsoft.Maui.Controls.Xaml;

namespace Test;

[XamlProcessing(XamlInflator.SourceGen)]
public partial class TestPage : ContentPage
{
	public TestPage()
	{
		InitializeComponent();
	}
}
""";

		var testXamlFilePath = Path.Combine(Environment.CurrentDirectory, "Test.xaml");
		var expected =
$$"""

//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a .NET MAUI source generator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable

namespace Test;

[global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.Maui.Controls.SourceGen, Version=10.0.0.0, Culture=neutral, PublicKeyToken=null", "10.0.0.0")]
public partial class TestPage
{
	private partial void InitializeComponent()
	{
		var inflator = new TestPageInflator();
#line 6 "{{testXamlFilePath}}"
		this.SetValue(global::Microsoft.Maui.Controls.Page.TitleProperty, "Test Page");
#line default
#line 7 "{{testXamlFilePath}}"
		this.SetValue(global::Microsoft.Maui.Controls.ContentPage.ContentProperty, inflator.stackLayout);
#line default
	}
}

file ref struct TestPageInflator {
	public global::Microsoft.Maui.Controls.Button button  {
		get {
			if (field != null)
				return field;
			field = Create(this);
			SetProperties(field, this);
			return field;
			
			static global::Microsoft.Maui.Controls.Button Create(TestPageInflator inflator) {
				var button1 = new global::Microsoft.Maui.Controls.Button();
				global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(button1!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 8, 5);
				return button1;
			}
			
			static void SetProperties(global::Microsoft.Maui.Controls.Button @field, TestPageInflator inflator) {
#line 8 "/Users/sde/Projects/Microsoft/maui/artifacts/bin/SourceGen.UnitTests/Debug/net10.0/Test.xaml"
				@field.SetValue(global::Microsoft.Maui.Controls.Button.TextProperty, "Hello MAUI!");
#line default
			}
		}
	}

	public global::Microsoft.Maui.Controls.StackLayout stackLayout  {
		get {
			if (field != null)
				return field;
			field = Create(this);
			SetProperties(field, this);
			return field;
			
			static global::Microsoft.Maui.Controls.StackLayout Create(TestPageInflator inflator) {
				var stackLayout1 = new global::Microsoft.Maui.Controls.StackLayout();
				global::Microsoft.Maui.VisualDiagnostics.RegisterSourceInfo(stackLayout1!, new global::System.Uri(@"Test.xaml;assembly=SourceGeneratorDriver.Generated", global::System.UriKind.Relative), 7, 4);
				return stackLayout1;
			}
			
			static void SetProperties(global::Microsoft.Maui.Controls.StackLayout @field, TestPageInflator inflator) {
#line 8 "{{testXamlFilePath}}"
				((global::System.Collections.Generic.ICollection<global::Microsoft.Maui.IView>)@field.Children).Add((global::Microsoft.Maui.IView)inflator.button);
#line default
			}
		}
	}


}

""";

		var (result, generated) = RunGenerator(xaml, code, treeOrder:true);
		Assert.IsFalse(result.Diagnostics.Any());
		Assert.AreEqual(expected, generated);		 
	}
}
